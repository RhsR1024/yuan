ğŸ–•æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚ 

---

## ç®€ä»‹

è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è¿°jdkæœ¬èº«çš„æºç è¯¥å¦‚ä½•é˜…è¯»ï¼Œå…³äºå„ç§æ¡†æ¶çš„æºç é˜…è¯»æˆ‘ä»¬åé¢å†ä¸€èµ·æ¢è®¨ã€‚

ç¬”è€…è®¤ä¸ºé˜…è¯»æºç ä¸»è¦åŒ…æ‹¬ä¸‹é¢å‡ ä¸ªæ­¥éª¤ã€‚

## è®¾å®šç›®æ ‡

å‡¡äº‹çš†æœ‰ç›®çš„ï¼Œé˜…è¯»æºç ä¹Ÿæ˜¯ä¸€æ ·ã€‚

ä»å¤§çš„æ–¹é¢æ¥è¯´ï¼Œæˆ‘ä»¬é˜…è¯»æºç çš„ç›®çš„æ˜¯ä¸ºäº†æå‡è‡ªå·±çš„æŠ€æœ¯èƒ½åŠ›ï¼Œè¿ç”¨åˆ°å·¥ä½œä¸­ï¼Œé‡åˆ°é—®é¢˜å¿«é€Ÿå®šä½ï¼Œå‡èŒåŠ è–ªç­‰ç­‰ã€‚

ä»å°çš„æ–¹é¢æ¥è¯´ï¼Œé˜…è¯»æŸä¸€æ®µæºç çš„ç›®çš„å°±æ˜¯è¦ææ¸…æ¥šå®ƒçš„åŸç†ï¼Œå°±æ˜¯æ­»ç£•ï¼Œå°±æ˜¯é‚£ç§æ¢ç´¢çœŸç›¸çš„å›ºæ‰§ã€‚

ç›®çš„æ˜¯æŠ½è±¡çš„ï¼Œç›®æ ‡æ˜¯å…·ä½“çš„ï¼Œæˆ‘ä»¬é˜…è¯»æºç ä¹‹å‰ä¸€å®šè¦ç»™è‡ªå·±è®¾å®šä¸€ä¸ªç›®æ ‡ã€‚

æ¯”å¦‚ï¼Œä¸‹ä¸€ç« æˆ‘ä»¬å°†è¦ä¸€èµ·å­¦ä¹ çš„ConcurrentHashMapï¼Œæˆ‘ä»¬å¯ä»¥è®¾å®šä»¥ä¸‹ç›®æ ‡ï¼š

ï¼ˆ1ï¼‰ç†Ÿæ‚‰ConcurrentHashMapçš„å­˜å‚¨ç»“æ„ï¼›

ï¼ˆ2ï¼‰ç†Ÿæ‚‰ConcurrentHashMapä¸­ä¸»è¦æ–¹æ³•çš„å®ç°è¿‡ç¨‹ï¼›

ï¼ˆ3ï¼‰æ¢ç´¢ConcurrentHashMapä¸­å‡ºç°çš„æ–°æŠ€æœ¯ï¼›

## æå‡ºé—®é¢˜

æœ‰äº†ç›®æ ‡ä¹‹åï¼Œæˆ‘ä»¬è¦è¯•ç€æå‡ºä¸€äº›é—®é¢˜ã€‚

è¿˜æ˜¯ä»¥ConcurrentHashMapä¸ºä¾‹ï¼Œç¬”è€…æå‡ºäº†ä»¥ä¸‹è¿™äº›é—®é¢˜ï¼š

ï¼ˆ1ï¼‰ConcurrentHashMapä¸HashMapçš„æ•°æ®ç»“æ„æ˜¯å¦ä¸€æ ·ï¼Ÿ

ï¼ˆ2ï¼‰HashMapåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½•æ—¶ä¼šå‡ºç°å¹¶å‘å®‰å…¨é—®é¢˜ï¼Ÿ

ï¼ˆ3ï¼‰ConcurrentHashMapæ˜¯æ€ä¹ˆè§£å†³å¹¶å‘å®‰å…¨é—®é¢˜çš„ï¼Ÿ

ï¼ˆ4ï¼‰ConcurrentHashMapä½¿ç”¨äº†å“ªäº›é”ï¼Ÿ

ï¼ˆ5ï¼‰ConcurrentHashMapçš„æ‰©å®¹æ˜¯æ€ä¹ˆè¿›è¡Œçš„ï¼Ÿ

ï¼ˆ6ï¼‰ConcurrentHashMapæ˜¯å¦æ˜¯å¼ºä¸€è‡´æ€§çš„ï¼Ÿ

ï¼ˆ7ï¼‰ConcurrentHashMapä¸èƒ½è§£å†³å“ªäº›é—®é¢˜ï¼Ÿ

ï¼ˆ8ï¼‰ConcurrentHashMapé™¤äº†å¹¶å‘å®‰å…¨ï¼Œè¿˜æœ‰å“ªäº›ä¸HashMapä¸åŒçš„åœ°æ–¹ï¼Œä¸ºä»€ä¹ˆè¦é‚£ä¹ˆå®ç°ï¼Ÿ

ï¼ˆ8ï¼‰ConcurrentHashMapä¸­æœ‰å“ªäº›ä¸å¸¸è§çš„æŠ€æœ¯å€¼å¾—å­¦ä¹ ï¼Ÿ

## å¦‚ä½•æå‡ºé—®é¢˜

å¾ˆå¤šäººä¼šè¯´ï¼Œæˆ‘ä¹ŸçŸ¥é“è¦æå‡ºé—®é¢˜ï¼Œä½†æ˜¯è¯¥æ€ä¹ˆæå‡ºé—®é¢˜å‘¢ï¼Ÿ

è¿™ç¡®å®æ˜¯å¾ˆå›°éš¾çš„ä¸€ä»¶äº‹ï¼Œç¬”è€…è®¤ä¸ºä¸»è¦æ˜¯ä¸‰ç‚¹ï¼š

ï¼ˆ1ï¼‰é—®è‡ªå·±

æŠŠè‡ªå·±å½“æˆé¢è¯•å®˜é—®è‡ªå·±ï¼Œå¾€æ­»é‡Œé—®çš„é‚£ç§ã€‚

å¦‚æœé—®è‡ªå·±é—®ä¸å‡ºå‡ ä¸ªé—®é¢˜ï¼Œä¹Ÿä¸è¦ç´§ï¼Œè¯·çœ‹ä¸‹é¢ã€‚

ï¼ˆ2ï¼‰é—®äº’è”ç½‘

å¾ˆå¤šé—®é¢˜å¯èƒ½è‡ªå·±ä¹Ÿæƒ³ä¸åˆ°ï¼Œé‚£å°±éœ€è¦ä¸Šç½‘å¤§æ¦‚æŸ¥ä¸€ä¸‹ç›¸å…³çš„åšå®¢ï¼Œçœ‹äººå®¶æœ‰æ²¡æœ‰æå‡ºä»€ä¹ˆé—®é¢˜ã€‚

æˆ–è€…ï¼ŒæŸ¥è¯¢ç›¸å…³é¢è¯•é¢˜ã€‚

æ¯”å¦‚ï¼Œç¬”è€…å­¦ä¹ ConcurrentHashMapè¿™ä¸ªç±»æ—¶ï¼Œä¸Šç½‘ä¸€æŸ¥å¾ˆå¤šéƒ½æ˜¯åŸºäºjdk7çš„ï¼Œé‚£è¿™æ—¶å€™å°±å¯ä»¥æå‡ºä¸€ä¸ªé—®é¢˜ï¼Œjdk8ä¸jdk7ä¸­ConcurrentHashMapè¿™ä¸ªç±»çš„å®ç°æ–¹å¼æœ‰ä½•ä¸åŒï¼Ÿjdk8å¯¹jdk7ä½œäº†å“ªäº›ä¼˜åŒ–ï¼Ÿ

ï¼ˆ3ï¼‰ä¸æ–­å‘ç°é—®é¢˜

åœ¨æºç é˜…è¯»çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½çœ‹ç€çœ‹ç€å°±é‡åˆ°ä¸ªé—®é¢˜ï¼Œè¿™æ˜¯éå¸¸å¸¸è§çš„ï¼Œè¿™ç§é—®é¢˜ä¹Ÿåº”è¯¥ä¿ç•™ä¸‹æ¥ç ”ç©¶ç ”ç©¶ã€‚

æ¯”å¦‚ï¼ŒConcurrentHashMapä¸­size()æ–¹æ³•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ`@sun.misc.Contended`è¿™ç©æ„æ˜¯ä»€ä¹ˆé¬¼ä¸œè¥¿ï¼Ÿç„¶åä¸Šç½‘ä¸€æŸ¥ï¼Œä¸æ˜¯ä¸ºäº†é¿å…ä¼ªå…±äº«ï¼Œæˆ‘Xï¼Œ`ä¼ªå…±äº«`åˆæ˜¯å•¥ï¼Ÿç„¶åä½ å†æŸ¥ä¸€ä¸‹`ä¼ªå…±äº«`ï¼Œåˆå‡ºæ¥äº†CPUå¤šçº§ç¼“å­˜ï¼Ÿå­¦å®ŒCPUå¤šçº§ç¼“å­˜ï¼Œæ˜¯ä¸æ˜¯è§‰å¾—è·Ÿjvmçš„å†…å­˜æ¨¡å‹å¾ˆåƒï¼Ÿé—®å®Œè¿™ä¸€è¿ä¸²é—®é¢˜ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰ä¸–ç•Œéƒ½æ¸…æ™°äº†ï¼Ÿ^_^

çœ‹å§ï¼Œé—®é¢˜æ˜¯æºæºä¸æ–­åœ°è¢«å‘ç°çš„ã€‚

æ‰€ä»¥ï¼Œä¸€å¼€å§‹æä¸å‡ºå‡ ä¸ªé—®é¢˜ä¹Ÿä¸è¦ç´§ï¼Œå…³é”®æ˜¯è¦çœ‹ï¼Œçœ‹äº†æ‰èƒ½å‘ç°æ›´å¤šçš„é—®é¢˜ã€‚

## å¸¦ç€é—®é¢˜é˜…è¯»æºç ï¼Œå¿½ç•¥ä¸å¿…è¦çš„ç»†èŠ‚ï¼Œæ­»ç£•é‡è¦çš„ç»†èŠ‚

é¦–å…ˆï¼Œä¸€å®šè¦å¸¦ç€é—®é¢˜é˜…è¯»æºç ã€‚

å…¶æ¬¡ï¼Œä¸€å®šè¦å¿½ç•¥ä¸å¿…è¦çš„ç»†èŠ‚ã€‚

å†æ¬¡ï¼Œä¸€å®šè¦æ­»ç£•é‡è¦çš„ç»†èŠ‚ã€‚

ä¹ä¸€çœ‹ï¼Œåé¢ä¸¤æ­¥ä¼¼ä¹æœ‰æ‰€çŸ›ç›¾ï¼Œå…¶å®ä¸ç„¶ï¼Œå¿½ç•¥ä¸å¿…è¦çš„ç»†èŠ‚æ˜¯ä¸ºäº†ä¸è¿·å¤±åœ¨æºç çš„ä¸–ç•Œä¸­ï¼Œæ­»ç£•é‡è¦çš„ç»†èŠ‚æ˜¯ä¸ºäº†å¼„æ¸…æ¥šæºç çš„çœŸç›¸ã€‚

è¿™é‡Œçš„ç»†èŠ‚æ˜¯å¿½ç•¥è¿˜æ˜¯æ­»ç£•ï¼Œä¸»è¦æ˜¯çœ‹è·Ÿé—®é¢˜çš„ç›¸å…³æ€§ã€‚

jdkæºç è¿˜æ˜¯æ¯”è¾ƒå¥½é˜…è¯»çš„ï¼Œå¦‚æœåé¢çœ‹springçš„æºç ï¼Œåšä¸åˆ°å¿½ç•¥ä¸å¿…è¦çš„ç»†èŠ‚ï¼ŒçœŸçš„æ˜¯ä¼šè¿·å¤±çš„ï¼Œå…ˆåŸ‹ä¸ªä¼ç¬”å“ˆ~~

ä¸¾ä¸ªä¾‹å­ï¼Œä¹‹å‰é˜…è¯»è¿‡ArrayListçš„åºåˆ—åŒ–ç›¸å…³çš„ä»£ç ä¸­çš„readObject()æ–¹æ³•ã€‚

`s.readInt();`è¿™è¡Œæ˜¯å¹²å˜›çš„ï¼Ÿçœç•¥è¡Œä¸è¡Œï¼Ÿè¿™æ—¶å€™å°±è¦å»äº†è§£åºåˆ—åŒ–ç›¸å…³çš„çŸ¥è¯†ï¼Œç„¶åçœ‹çœ‹writeObject()é‡Œé¢çš„å®ç°ï¼Œè¿™å°±æ˜¯è¦æ­»ç£•çš„ä»£ç ã€‚

`SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, capacity);`è¿™è¡Œåˆæ˜¯å¹²å˜›çš„ï¼Ÿä¹ä¸€çœ‹ï¼Œå¥½åƒæ˜¯è·Ÿæƒé™ç›¸å…³çš„ä»£ç ï¼Œè·Ÿæˆ‘ä»¬çš„é—®é¢˜â€œåºåˆ—åŒ–â€æ— å…³ï¼Œå¿½ç•¥ä¹‹ï¼Œå¦‚æœå®åœ¨æƒ³çŸ¥é“ï¼Œå…ˆæ‰“ä¸ªæ ‡è®°ï¼Œç­‰æŠŠåºåˆ—åŒ–çš„é—®é¢˜è§£å†³äº†å†æ¥ç ”ç©¶è¿™ä¸ªä¸œè¥¿ã€‚

```java
private void readObject(java.io.ObjectInputStream s)
        throws java.io.IOException, ClassNotFoundException {
    // å£°æ˜ä¸ºç©ºæ•°ç»„
    elementData = EMPTY_ELEMENTDATA;

    // è¯»å…¥étransientéstaticå±æ€§ï¼ˆä¼šè¯»å–sizeå±æ€§ï¼‰
    s.defaultReadObject();

    // è¯»å…¥å…ƒç´ ä¸ªæ•°ï¼Œæ²¡ä»€ä¹ˆç”¨ï¼Œåªæ˜¯å› ä¸ºå†™å‡ºçš„æ—¶å€™å†™äº†sizeå±æ€§ï¼Œè¯»çš„æ—¶å€™ä¹Ÿè¦æŒ‰é¡ºåºæ¥è¯»
    s.readInt();

    if (size > 0) {
        // è®¡ç®—å®¹é‡
        int capacity = calculateCapacity(elementData, size);
        SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, capacity);
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹
        ensureCapacityInternal(size);
        
        Object[] a = elementData;
        // ä¾æ¬¡è¯»å–å…ƒç´ åˆ°æ•°ç»„ä¸­
        for (int i=0; i<size; i++) {
            a[i] = s.readObject();
        }
    }
}
```

## å¤šåšæ¯”è¾ƒ

åœ¨é˜…è¯»jdkæºç çš„æ—¶å€™ï¼Œè¿˜æœ‰å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå°±æ˜¯è¦å¤šåšæ¯”è¾ƒï¼Œæ¯”è¾ƒä¹Ÿå¯ä»¥åˆ†ä¸ºæ¨ªå‘æ¯”è¾ƒå’Œçºµå‘æ¯”è¾ƒã€‚

ï¼ˆ1ï¼‰æ¨ªå‘æ¯”è¾ƒ

å°±æ˜¯ä¸ç›¸ä¼¼çš„ç±»åšæ¯”è¾ƒã€‚æ¯”å¦‚ï¼Œé›†åˆæ¨¡å—ä¸­ï¼ŒåŸºæœ¬éƒ½æ˜¯å„ç§æ’å…¥ã€æŸ¥è¯¢ã€åˆ é™¤å…ƒç´ ï¼Œé‚£è¿™æ—¶å€™å¯ä»¥ä»æ•°æ®ç»“æ„ã€æ—¶é—´å¤æ‚åº¦ç­‰ç»´åº¦è¿›è¡Œæ¯”è¾ƒï¼Œè¿™å°±æ˜¯æ¨ªå‘æ¯”è¾ƒã€‚

ï¼ˆ2ï¼‰çºµå‘æ¯”è¾ƒ

å¯ä»¥ä»é›†åˆå‘å±•çš„å†å²è¿›è¡Œæ¯”è¾ƒã€‚æ¯”å¦‚ï¼ŒHashMapçš„å‘å±•å²ï¼Œä»ï¼ˆå•ä¸ªæ•°ç»„ï¼‰å®ç°ï¼ˆæ²¡é”™ï¼Œå¯ä»¥ç›´æ¥ç”¨ä¸€ä¸ªæ•°ç»„å®ç°HashMapï¼‰ï¼Œåˆ°ï¼ˆå¤šæ•°ç»„+é“¾è¡¨ï¼‰å®ç°ï¼Œå†åˆ°jdk8ä¸­çš„ï¼ˆå¤šæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ï¼‰å®ç°ï¼Œè¿™å°±æ˜¯çºµå‘æ¯”è¾ƒã€‚

## å¤šåšå®éªŒ

æœ€åä¸€æ­¥ï¼Œæœ€æœ€æœ€æœ€é‡è¦çš„å°±æ˜¯è¦å¤šåšå®éªŒã€‚

æ¯”å¦‚ï¼ŒConcurrentHashMapæ˜¯ä¸æ˜¯å¼ºä¸€è‡´æ€§çš„ï¼Ÿ

å¯ä»¥å¯åŠ¨å¤šä¸ªçº¿ç¨‹å»ä¸æ–­è°ƒç”¨get()ã€put()ã€size()æ–¹æ³•ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å¼ºä¸€è‡´æ€§çš„ã€‚

### å½©è›‹

å“å‘€ï¼Œä¸€ä¸å°å¿ƒé€éœ²äº†ä¸‹ä¸€ç« ConcurrentHashMapçš„å†…å®¹ã€‚

å¤§å®¶å¯ä»¥ç”¨æœ¬ç¯‡æ‰€è¯´çš„æ–¹æ³•è¯•ç€é˜…è¯»ä¸€ä¸‹ConcurrentHashMapçš„æºç ï¼Œä¸‹ä¸€ç« æˆ‘ä»¬å†ä¸€èµ·å­¦ä¹ å“ˆå“ˆ~~

---

å¦‚æœä½ è§‰å¾—æœ¬ç¯‡è¿˜ç®—æœ‰ç”¨

èµä¸ªé¸¡è…¿å‘—ğŸ˜‰

